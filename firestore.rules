rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isAuth() { return request.auth != null; }
    function claims() { return request.auth.token; }
    function hasRole(role) { return isAuth() && claims()[role] == true; }
    function isSuperAdmin() { return hasRole('super_admin'); }
    function isAdmin() { return hasRole('admin') || isSuperAdmin(); }
    function isOps() { return hasRole('ops') || isAdmin(); }
    function isSupport() { return hasRole('support') || isOps(); }
    function isPrivacyAdmin() { return hasRole('privacy_admin') || isSuperAdmin(); }

    match /{path=**} { allow read, write: if false; }

    match /systemConfig/{docId} {
      allow read: if isAdmin();
      allow write: if isSuperAdmin();
    }
    match /featureFlags/{flagId} {
      allow read: if isAuth();
      allow write: if isAdmin();
    }
    
    match /adminUsers/{uid} {
      allow get: if isSupport();
      allow list: if isSupport();
      allow create, update: if isSuperAdmin();
    }

    match /auditEvents/{eventId} {
      allow read: if isOps();
      allow write: if false; // Server-side writes only
    }

    match /jobAdminViews/{jobId} {
      allow read: if isOps();
      allow write: if false; 
    }
    
    match /moderationReports/{reportId} {
      allow read, write: if hasRole('reviewer') || isAdmin();
    }
    match /privacyRequests/{reqId} {
      allow read, write: if isPrivacyAdmin();
    }
  }
}
