rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function hasClaim(role) {
      return request.auth.token.uraiRole == role;
    }

    function hasOneOfRoles(roles) {
      return request.auth.token.uraiRole in roles;
    }

    function isActiveAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/adminUsers/$(request.auth.uid));
    }

    // Deny all access by default
    match /{document=**} {
      allow read, write: if false;
    }

    // Superadmin can manage adminUsers
    match /adminUsers/{uid} {
      allow read, write: if isActiveAdmin() && hasClaim('superadmin');
    }

    // Admin and Superadmin can view auditLogs
    match /auditLogs/{logId} {
      allow read, write: if isActiveAdmin() && hasOneOfRoles(['admin', 'superadmin']);
    }

    // Admin and Superadmin can manage featureFlags
    match /featureFlags/{flagId} {
      allow read, write: if isActiveAdmin() && hasOneOfRoles(['admin', 'superadmin']);
    }

    // Support, Admin, and Superadmin can read support cases and incidents
    match /supportCases/{caseId} {
      allow read: if isActiveAdmin() && hasOneOfRoles(['support', 'admin', 'superadmin']);
    }

    match /incidents/{incidentId} {
      allow read: if isActiveAdmin() && hasOneOfRoles(['support', 'admin', 'superadmin']);
    }

    // Analyst can read analytics data (example)
    // match /analytics/{docId} {
    //   allow read: if isActiveAdmin() && hasOneOfRoles(['analyst', 'admin', 'superadmin']);
    // }
  }
}