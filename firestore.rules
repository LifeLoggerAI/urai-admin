rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Deny by default
    match /{document=**} {
      allow read, write: if false;
    }

    // Custom claims check function
    function hasRole(role) {
      return request.auth.token.roles[role] == true;
    }

    // adminUsers document check function
    function isAdmin() {
      return exists(/databases/$(database)/documents/adminUsers/$(request.auth.uid));
    }

    // Specific role checks
    function isSuperAdmin() {
      return hasRole('superAdmin');
    }

    function isCouncil() {
      return hasRole('council');
    }

    function isOps() {
      return hasRole('ops');
    }

    function isSupport() {
      return hasRole('support');
    }

    function isAuditor() {
      return hasRole('auditor');
    }

    function isModerator() {
      return hasRole('moderator');
    }

    // Collection-level rules
    match /adminUsers/{uid} {
      allow read, write: if isSuperAdmin();
      allow read: if isAdmin();
    }

    match /featureFlags/{flagId} {
      allow read: if isAdmin();
      allow write: if isSuperAdmin() || isCouncil() || isOps();
    }

    match /config/global {
      allow read: if isAdmin();
      allow write: if isSuperAdmin();
    }

    match /incidents/{incidentId} {
      allow read: if isAdmin();
      allow write: if isSuperAdmin() || isCouncil() || isOps();
    }

    match /systemHealth/{docId} {
      allow read: if isAdmin();
      allow write: if isSuperAdmin() || isCouncil() || isOps();
    }

    match /adminAuditLogs/{logId} {
      allow read: if isAuditor() || isSuperAdmin();
      allow write: if false; // Server only
    }

    match /supportCases/{caseId} {
      allow read: if isSupport() || isModerator() || isAuditor() || isSuperAdmin();
      allow write: if isSupport() || isModerator() || isSuperAdmin();
    }

    match /adminTasks/{taskId} {
      allow read: if isOps() || isSuperAdmin();
      allow write: if isOps() || isSuperAdmin();
    }

    match /crossProjectTokens/{tokenId} {
      allow read: if isSuperAdmin();
      allow write: if false; // Server only
    }
  }
}